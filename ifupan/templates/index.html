<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能复盘系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @media (max-width: 768px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            .nav-tabs .nav-link {
                padding: 0.5rem 0.5rem;
            }
            #myTabContent {
                margin-top: 1rem;
            }
            .btn {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-5">AI智能复盘系统</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab" aria-controls="text" aria-selected="true">文字交互复盘</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="mindmap-tab" data-bs-toggle="tab" data-bs-target="#mindmap" type="button" role="tab" aria-controls="mindmap" aria-selected="false">思维导图形式展示</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="speech-tab" data-bs-toggle="tab" data-bs-target="#speech" type="button" role="tab" aria-controls="speech" aria-selected="false">语音交互复盘</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane fade show active" id="text" role="tabpanel" aria-labelledby="text-tab">
                <select id="text-prompt-type" class="form-select mb-2">
                    <option value="diary">日记复盘</option>
                    <option value="study">学习复盘</option>
                    <option value="meeting">会议复盘</option>
                </select>
                <textarea id="text-input" class="form-control mb-2" rows="4"></textarea>
                <button onclick="analyzeText()" class="btn btn-primary">分析</button>
                <div id="text-result" class="mt-3 p-3 bg-white rounded shadow-sm"></div>
            </div>
            <div class="tab-pane fade" id="mindmap" role="tabpanel" aria-labelledby="mindmap-tab">
                <select id="mindmap-prompt-type" class="form-select mb-2">
                    <option value="diary">日记复盘</option>
                    <option value="study">学习复盘</option>
                    <option value="meeting">会议复盘</option>
                </select>
                <textarea id="mind-map-input" class="form-control mb-2" rows="4"></textarea>
                <button onclick="generateMindMap()" class="btn btn-primary w-100 mb-3">生成思维导图</button>
                <div id="mind-map-result" class="d-flex flex-wrap justify-content-center"></div>
            </div>
            <div class="tab-pane fade" id="speech" role="tabpanel" aria-labelledby="speech-tab">
                <select id="speech-prompt-type" class="form-select mb-2">
                    <option value="diary">日记复盘</option>
                    <option value="study">学习复盘</option>
                    <option value="meeting">会议复盘</option>
                </select>
                <div class="mb-3">
                    <button id="recordButton" onclick="toggleRecording()" class="btn btn-success mb-2 w-100">开始录音</button>
                    <div class="input-group mb-2">
                        <input type="file" id="audioFileInput" accept="audio/*" class="form-control" onchange="handleFileSelect()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearFileInput()">清除</button>
                    </div>
                </div>
                <button onclick="processAudio()" class="btn btn-primary w-100 mb-3">处理音频</button>
                <div id="speech-result" class="p-3 bg-white rounded shadow-sm"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function analyzeText() {
            const text = document.getElementById('text-input').value;
            const promptType = document.getElementById('text-prompt-type').value;
            axios.post('/analyze', { text: text, promptType: promptType }, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                const resultDiv = document.getElementById('text-result');
                resultDiv.innerHTML = marked.parse(response.data.result);
            });
        }

        function generateMindMap() {
            const text = document.getElementById('mind-map-input').value;
            const promptType = document.getElementById('mindmap-prompt-type').value;
            axios.post('/generate_mind_map', { text: text, promptType: promptType }, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                const mindMapLink = document.createElement('a');
                mindMapLink.href = `/download/${response.data.mind_map}`;
                mindMapLink.textContent = '下载思维导图';
                mindMapLink.download = response.data.mind_map;
                mindMapLink.className = 'btn btn-primary m-1';

                const pdfLink = document.createElement('a');
                pdfLink.href = `/download/${response.data.pdf}`;
                pdfLink.textContent = '下载PDF报告';
                pdfLink.download = response.data.pdf;
                pdfLink.className = 'btn btn-secondary m-1';

                const resultDiv = document.getElementById('mind-map-result');
                resultDiv.innerHTML = '';
                resultDiv.appendChild(mindMapLink);
                resultDiv.appendChild(pdfLink);
            });
        }

        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];

        function toggleRecording() {
            const recordButton = document.getElementById('recordButton');
            const fileInput = document.getElementById('audioFileInput');
            
            if (!isRecording) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();

                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        recordButton.textContent = '停止录音';
                        recordButton.classList.remove('btn-success');
                        recordButton.classList.add('btn-danger');
                        isRecording = true;
                        fileInput.disabled = true;
                    });
            } else {
                mediaRecorder.stop();
                recordButton.textContent = '开始录音';
                recordButton.classList.remove('btn-danger');
                recordButton.classList.add('btn-success');
                isRecording = false;
                fileInput.disabled = false;
            }
        }

        function processAudio() {
            const audioFile = document.getElementById('audioFileInput').files[0];
            const promptType = document.getElementById('speech-prompt-type').value;
            const formData = new FormData();

            if (audioFile) {
                formData.append("audio", audioFile);
            } else if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                formData.append("audio", audioBlob, "recording.wav");
            } else {
                alert("请先录音或上传音频文件");
                return;
            }

            formData.append("promptType", promptType);

            axios.post('/speech_to_text', formData)
                .then(response => {
                    const resultDiv = document.getElementById('speech-result');
                    resultDiv.innerHTML = marked.parse(response.data.result);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('处理音频时出错');
                });

            // Reset recording state
            audioChunks = [];
            const recordButton = document.getElementById('recordButton');
            recordButton.textContent = '开始录音';
            recordButton.classList.remove('btn-danger');
            recordButton.classList.add('btn-success');
            isRecording = false;
            document.getElementById('audioFileInput').disabled = false;
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('audioFileInput');
            const recordButton = document.getElementById('recordButton');
            
            if (fileInput.files.length > 0) {
                recordButton.disabled = true;
            } else {
                recordButton.disabled = false;
            }
        }

        function clearFileInput() {
            const fileInput = document.getElementById('audioFileInput');
            const recordButton = document.getElementById('recordButton');
            
            fileInput.value = '';
            recordButton.disabled = false;
        }
    </script>
</body>
</html>
